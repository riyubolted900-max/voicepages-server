<!DOCTYPE html>
<html>
<head><title>Audio Test</title></head>
<body>
<h2>VoicePages Audio Test</h2>
<div id="status">Loading...</div>
<br>
<button id="playBtn" disabled>Play</button>
<button id="genBtn">Generate & Play Chapter 1</button>
<br><br>
<audio id="player" controls style="width:100%"></audio>
<pre id="log"></pre>

<script>
const bookId = 'b022e526';
const log = (msg) => { document.getElementById('log').textContent += msg + '\n'; console.log(msg); };
const statusEl = document.getElementById('status');
const player = document.getElementById('player');
const playBtn = document.getElementById('playBtn');

// Test 1: Try fetching audio directly
async function testAudio(chapterId) {
  log(`Fetching GET /api/books/${bookId}/chapters/${chapterId}/audio ...`);
  try {
    const resp = await fetch(`/api/books/${bookId}/chapters/${chapterId}/audio`);
    log(`GET response: ${resp.status} ${resp.statusText}`);
    log(`Content-Type: ${resp.headers.get('content-type')}`);
    log(`Content-Length: ${resp.headers.get('content-length')}`);

    if (resp.status === 404) {
      log('Audio not cached, generating via POST...');
      const genResp = await fetch(`/api/books/${bookId}/chapters/${chapterId}/audio`, { method: 'POST' });
      log(`POST response: ${genResp.status} ${genResp.statusText}`);
      log(`Content-Type: ${genResp.headers.get('content-type')}`);
      log(`Content-Length: ${genResp.headers.get('content-length')}`);

      if (genResp.ok) {
        const blob = await genResp.blob();
        log(`Blob size: ${blob.size}, type: ${blob.type}`);
        const url = URL.createObjectURL(blob);
        player.src = url;
        playBtn.disabled = false;
        statusEl.textContent = 'Audio ready (from POST). Click Play or use player below.';
      }
    } else if (resp.ok) {
      const blob = await resp.blob();
      log(`Blob size: ${blob.size}, type: ${blob.type}`);
      const url = URL.createObjectURL(blob);
      player.src = url;
      playBtn.disabled = false;
      statusEl.textContent = 'Audio ready (from cache). Click Play or use player below.';
    }
  } catch (err) {
    log(`Error: ${err.message}`);
    statusEl.textContent = 'Error: ' + err.message;
  }
}

player.addEventListener('error', (e) => {
  log(`Audio element error: ${player.error?.message || 'unknown'} (code: ${player.error?.code})`);
});

player.addEventListener('canplay', () => {
  log('Audio canplay event fired - audio is playable!');
});

playBtn.onclick = () => player.play();
document.getElementById('genBtn').onclick = () => testAudio(1);

// Auto-test
fetch('/api/books').then(r => r.json()).then(books => {
  if (books.length > 0) {
    log(`Found book: ${books[0].id} - ${books[0].title}`);
    statusEl.textContent = 'Click "Generate & Play" to test audio';
  }
});
</script>
</body>
</html>
